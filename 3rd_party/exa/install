#!/bin/bash

export exa_cflags="${CFLAGS} -fPIC"
export exa_cxxflags="${CFLAGS} -fPIC"
export exa_fflags="${FFLAGS}"
export exa_build_dir="${EXA_DIR}"

function clean_exa_and_deps(){
  local cur_dir=`pwd`
  [ -d occa ] &&       cd occa       && make clean && cd ${cur_dir}
  [ -d gslib ] &&      cd gslib      && make clean && cd ${cur_dir}
  [ -d exaCore ] &&    cd exaCore    && make clean && cd ${cur_dir}
  [ -d exaHmholtz ] && cd exaHmholtz && make clean && cd ${cur_dir}

  rm -rf ${exa_build_dir} 2>/dev/null
  exit 0
}

function exit_err(){
  echo "Building exa libraries failed: $@"
  exit 1
}

function build_occa(){
  local cur_dir=`pwd`
  local commit=06ff328

  [ ! -d occa ] && \
    (git clone https://github.com/libocca/occa.git || exit_err ${LINENO})

  cd occa
  git checkout ${commit}
  CXX="${CXX}" CXXFLAGS="${exa_cxxflags}" make\
    PREFIX="${exa_build_dir}" -j4 all || exit_err ${LINENO}
  cd ${cur_dir}

  export OCCA_DIR="${exa_build_dir}"
}

function build_gslib(){
  local cur_dir=`pwd`

  [ ! -d gslib ] && \
    (git clone https://github.com/gslib/gslib.git || exit_err ${LINENO})

  cd gslib
  CC="${CC}" CFLAGS="${exa_cflags}" DESTDIR="${exa_build_dir}" make\
    -j4 install || exit_err ${LINENO}
  cd ${cur_dir}

  export GS_DIR="${exa_build_dir}"
}

function build_exa(){
  local cur_dir=`pwd`
  [ ! -d exaCore ] && \
    (git clone https://github.com/exaAlgo/exaCore.git || exit_err ${LINENO})

  cd exaCore
  CC="${CC}" CFLAGS="${exa_cflags}" FC="${FC}" FFLAGS="${exa_fflags}" \
    PREFIX="${exa_build_dir}" make -j4 install "${GPU_OPT}" || exit_err ${LINENO}
  cd ${cur_dir}

  export EXA_DIR=${exa_build_dir}

  [ ! -d exaHmholtz ] && \
    (git clone https://github.com/thilinarmtb/exaHmholtz.git || exit_err ${LINENO})

  cd exaHmholtz
  CC="${CC}" CFLAGS="${exa_cflags}" FC="${FC}" FFLAGS="${exa_fflags}" \
    PREFIX="${exa_build_dir}" make -j4 install "${GPU_OPT}" || exit_err ${LINENO}
  cd ${cur_dir}

  export EXA_HMHOLTZ_DIR=${exa_build_dir}
}

[ $# -eq 1 ] && [ "$1" = "clean" ] && clean_exa_and_deps

echo "Building exa libraries ..."
mkdir -p ${exa_build_dir}
build_occa
build_gslib
build_exa
echo "Finished building exa libraries."
